# Glide
### æ¦‚å†µ
é¦–å…ˆä¸ºä»€ä¹ˆè¦ç”¨Glideå‘¢ï¼Œæœ€ä¸»è¦çš„åŸå› å°±æ˜¯ç¼“å­˜æœºåˆ¶å’Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸç»‘å®š
#### ä¸€ã€ç¼“å­˜æœºåˆ¶
æ‰€æœ‰çš„å›¾ç‰‡ç¼“å­˜æœºåˆ¶éƒ½æ˜¯ä½¿ç”¨çš„ä¸‰çº§ç¼“å­˜ï¼Œå³å†…å­˜ç¼“å­˜ï¼Œç£ç›˜ç¼“å­˜ï¼ŒæœåŠ¡å™¨å­˜å‚¨ã€‚
![ä¸‰çº§ç¼“å­˜.png](https://upload-images.jianshu.io/upload_images/4356451-4a0481fc3f36f47c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
é™¤æ­¤ä¹‹å¤–ï¼ŒGlideçš„ç¼“å­˜çš„æ•°æ®æ˜¯ç”±Glideçš„å„ç§è®¾ç½®å†³å®šçš„ï¼Œä¾‹å¦‚ä¸€å¼ å›¾ç‰‡100x100è®¾ç½®å®½é«˜80x80å’Œ50x50çš„å›¾ç‰‡ä¸¤ç§ç±»å‹å±•ç¤ºï¼Œé‚£ä¹ˆç¼“å­˜ä¸­ä¼šå­˜åœ¨æœ‰80x80å’Œ50x50çš„ä¸¤å¼ å›¾ç‰‡ï¼Œå½“ä½ å†æ¬¡è®¾ç½®çš„æ—¶å€™å°±ç›´æ¥è¯»å–è¿™ä¸¤å¼ å›¾ç‰‡ï¼Œè€Œä¸æ˜¯è¯»å–åŸå›¾é‡æ–°è®¾ç½®å®½é«˜ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯ä½¿ç”¨ç©ºé—´æ¢å–æ—¶é—´çš„ç­–ç•¥ï¼Œè¿™å°±æ˜¯è§ä»è§æ™ºäº†ï¼Œç”±äºç›®å‰æ‰‹æœºçš„å†…å­˜ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚

#### äºŒã€ç”Ÿå‘½å‘¨æœŸç»‘å®š
Glide.with(context)
åœ¨ä½¿ç”¨Glideçš„æ—¶å€™ä¼šä¼ å…¥å½“å‰ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯é€šè¿‡ä¸Šä¸‹æ–‡æ˜¯æ— æ³•è·å–å½“å‰Activityç”Ÿå‘½å‘¨æœŸå›è°ƒçš„ï¼Œæ‰€ä»¥Glideä½¿ç”¨çš„ç­–ç•¥æ˜¯åœ¨å½“å‰Activityä¸­æ·»åŠ ä¸€ä¸ªç©ºç™½çš„Fragmentï¼Œé€šè¿‡è¯¥Fragmentæ¥è¿›è¡Œå›è°ƒå½“å‰ç•Œé¢çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨å½“å‰Fragmentçš„é”€æ¯çš„æ—¶å€™ï¼Œå°†å†…å­˜ä¸­çš„ç»‘å®šå½“å‰Activityçš„bitmapå›æ”¶ï¼Œå¯ä»¥å°†å ç”¨çš„å†…å­˜è¿›è¡Œé‡Šæ”¾ã€‚è¿™ä¸ªä¹Ÿæ˜¯æˆ‘æœ€å–œæ¬¢Glideçš„åŸå› ï¼Œå…¶ä»–çš„å›¾ç‰‡åŠ è½½æ¡†æ¶éƒ½æ˜¯äº‹å…ˆå ç”¨éƒ¨åˆ†çš„æ‰‹æœºå†…å­˜ï¼Œåªæœ‰åœ¨Appé€€å‡ºçš„æ—¶å€™æ‰ä¼šè¿›è¡Œé‡Šæ”¾ï¼Œå†…å­˜å…è®¸çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è¾¾åˆ°å½“å‰Appæ‰€æœ‰çš„å›¾ç‰‡éƒ½æ”¾åœ¨å†…å­˜ä¸­ï¼ŒåŠ è½½æ•ˆç‡æ›´å¿«ã€‚å¯æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œä¸åŒé¡µé¢å‡ºç°ç›¸åŒå›¾ç‰‡çš„æ¦‚ç‡è¿˜æ˜¯æ¯”è¾ƒå°çš„ï¼Œè€Œä¸”å°±ç®—æ˜¯å‡ºç°ç›¸åŒçš„å›¾ç‰‡ï¼Œé‚£ä¹Ÿåªæ˜¯å¾ˆå°‘çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘æ›´æ¬£èµGlideçš„åšæ³•ï¼Œå°†bitmapå’Œç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸbitmapå›æ”¶ï¼Œè¿™ä¹Ÿæ˜¯æ›´ç¬¦åˆæˆ‘ä»¬çš„ç¼–ç¨‹æ€æƒ³ã€‚
è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹å°±æ˜¯å¦‚ä½•å°†bitmapä¸å½“å‰çš„Activityè¿›è¡Œç»‘å®šã€‚è¿™é‡Œä½¿ç”¨çš„æ–¹æ¡ˆæ˜¯åˆ›å»ºä¸€ä¸ªHashMap<Int, ArrayList<String>>ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ”¾å…¥Activityçš„hashCodeï¼Œç”¨æ¥å¯¹åº”Activityï¼Œç¬¬äºŒä¸ªå‚æ•°æ”¾å…¥å†…å­˜ç¼“å­˜ä¸­å­˜å…¥bitmapçš„keyï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰¾åˆ°å½“å‰Activityçš„hashCodeæ¥è·å–æ‰€æœ‰çš„å†…å­˜ç¼“å­˜çš„bitmapçš„keyé›†åˆï¼Œå†é€šè¿‡è¿™äº›keyæ¥è·å–bitmapè¿›è¡Œå›æ”¶ã€‚

### æ‰‹æ’¸Glide ï¼ˆéå®˜æ–¹ï¼‰
#### ç¼“å­˜
é‚£ä¹ˆé¦–å…ˆä»¿ç…§Glideçš„æ ·å­æ¥åˆ›å»ºä¸€ä¸ªGlide
```
        Glide.with(this)
                .load(url)
                .placeHolder(R.mipmap.loading)
                .error(R.mipmap.error)
                .listener({
                    log("å›¾ç‰‡åŠ è½½æˆåŠŸ url = $url " +
                            "width = ${it.width} " +
                            "height = ${it.height}")
                }, {
                    log("å›¾ç‰‡åŠ è½½å¤±è´¥")
                })
                .into(imageView)
```
é‚£ä¹ˆå¯¹äºGlideæ¥è¯´withæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªBitmapRequestï¼Œæ‰€ä»¥withæ–¹æ³•è¿”å›ä¸€ä¸ªbitmapçš„è¯·æ±‚å®ä½“
###### Glide
```
object Glide {
    fun with(activity: AppCompatActivity): BitmapRequest {
        return BitmapRequest(activity)
    }
}
```
###### BitmapRequest
å¯¹äºä¸€ä¸ªBitmapRequestæ¥è¯´æˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸€å¼ å›¾ç‰‡çš„åŸºæœ¬æ•°æ®ï¼Œåœ°å€urlï¼Œå›¾ç‰‡imageViewï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›å‹å¥½è®¾ç½®ï¼ŒåŠ è½½å ä½å›¾placeHolderResï¼ŒåŠ è½½å¤±è´¥å›¾errorResï¼ŒåŠ è½½ç›‘å¬listeneræˆåŠŸå’Œå¤±è´¥ã€‚å¯¹äºå›¾ç‰‡æ¥è¯´ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³ç›´æ¥æŒæœ‰ï¼Œæ‰€ä»¥é‡‡ç”¨è½¯å¼•ç”¨çš„æ–¹å¼SoftReference<ImageView>ï¼Œæ­¤å¤–å¯¹äºç¼“å­˜æ¥è¯´éœ€è¦ä¸€ä¸ªkeyæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå‚æ•°uriMd5
```
class BitmapRequest(private var activity: Activity) {

	private var imageUrl: String? = null

	private var uriMd5: String? = null

	private var mSoftImageView: SoftReference<ImageView>? = null

	private var requestListener: BitmapRequestListener? = null

	private var placeHolderRes: Int? = null

	private var errorRes: Int? = null

	fun load(imageUrl: String): BitmapRequest {
		this.imageUrl = imageUrl
		uriMd5 = MD5Utils.toMD5(imageUrl)
		return this
	}

	fun placeHolder(placeHolderRes: Int): BitmapRequest {
		this.placeHolderRes = placeHolderRes
		return this
	}

	fun error(errorRes: Int): BitmapRequest {
		this.errorRes = errorRes
		return this
	}

	fun listener(requestListener: BitmapRequestListener): BitmapRequest {
		this.requestListener = requestListener
		return this
	}

	fun listener(onResourceReady: (bitmap: Bitmap) -> Unit, onException: () -> Unit): BitmapRequest {
		listener(object : BitmapRequestListener {
			/**
			 * å›¾ç‰‡åŠ è½½æˆåŠŸ
			 */
			override fun onResourceReady(bitmap: Bitmap) {
				onResourceReady(bitmap)
			}

			/**
			 * å›¾ç‰‡åŠ è½½å¼‚å¸¸
			 */
			override fun onException() {
				onException()
			}
		})
		return this
	}

	fun into(imageView: ImageView) {
		mSoftImageView = SoftReference(imageView)
		imageView.tag = uriMd5
        RequestManager.INSTANCE.addBitmapRequest(this)
	}

	fun getActivity():Activity = activity

	@Nullable
	fun getImageUrl(): String? = imageUrl

	@Nullable
	fun getUriMd5(): String? = uriMd5

	@Nullable
	fun getPlaceHolder(): Int? = placeHolderRes

	@Nullable
	fun getError(): Int? = errorRes

	@Nullable
	fun getRequestListener(): BitmapRequestListener? = requestListener

	@Nullable
	fun getImageView(): ImageView? = mSoftImageView?.get()

	override fun toString(): String {
		return "BitmapRequest(activity=$activity, imageUrl=$imageUrl, uriMd5=$uriMd5, mSoftImageView=$mSoftImageView, requestListener=$requestListener, placeHolderRes=$placeHolderRes, errorRes=$errorRes)"
	}

}


interface BitmapRequestListener {
    /**
     * å›¾ç‰‡åŠ è½½æˆåŠŸ
     */
    fun onResourceReady(bitmap:Bitmap)

    /**
     * å›¾ç‰‡åŠ è½½å¼‚å¸¸
     */
    fun onException()
}
```
###### BitmapManager
ç”±äºå›¾ç‰‡åŠ è½½è‚¯å®šä¸ä¼šæ˜¯ä¸€å¼ ä¸€å¼ çš„åŠ è½½ï¼Œè¿™é‡Œå°±å­˜åœ¨å¹¶å‘çš„é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ„å»ºä¸€ä¸ªåŠ è½½é˜Ÿåˆ—ï¼Œå°†ä¸€ä¸ªä¸ªå›¾ç‰‡åŠ è½½è¯·æ±‚æ”¾å…¥è¿™ä¸ªè¯·æ±‚é˜Ÿåˆ—å»è¿›è¡ŒåŠ è½½å›¾ç‰‡ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çœ‹æ‰‹æœºçš„cpuæ ¸å¿ƒæ•°æ¥è¿›è¡Œåˆ†é…å‡ æ¡æµæ°´çº¿æ¥è¿›è¡ŒåŠ è½½ã€‚
```
class RequestManager private constructor() {


    /*** è¯·æ±‚è°ƒåº¦ ç»™äºˆå¤šä¸ªæ¥è§£å†³å¹¶å‘é—®é¢˜ ***/
    private val dispatchers: ArrayList<RequestDispatcher> = arrayListOf()


    companion object {
        val INSTANCE: RequestManager by lazy(mode = LazyThreadSafetyMode.SYNCHRONIZED) {
            val manager = RequestManager()
            manager.start()
            manager
        }
    }

    /*** è¯·æ±‚é˜Ÿåˆ— ***/
    private val requestQueue = LinkedBlockingQueue<BitmapRequest>()

    /**
     * æ·»åŠ ä¸€ä¸ªç½‘ç»œè¯·æ±‚
     */
    fun addBitmapRequest(request: BitmapRequest) {
        //å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰è¿™ä¸ªå›¾ç‰‡è¯·æ±‚ æ·»åŠ 
        if (!requestQueue.contains(request)) {
            requestQueue.add(request)
        } else {
            log("å½“å‰ä»»åŠ¡å·²å­˜åœ¨\n$request")
        }
    }

    /**
     * å¼€å¯è¯·æ±‚ï¼Œé€šè¿‡RequestDispatcherè¿›è¡Œè°ƒåº¦ è·å–bitmap
     */
    private fun start() {
        stop()
        val threadCount: Int = Runtime.getRuntime().availableProcessors()
        for (i in 0 until threadCount) {
            val requestDispatcher = RequestDispatcher(requestQueue)
            //å¼€å§‹åŠ è½½bitmap
            requestDispatcher.start()
            dispatchers.add(requestDispatcher)
        }
    }

    /**
     * å…³é—­çº¿ç¨‹
     */
    private fun stop() {
        if (dispatchers.isNotEmpty()) {
            for (dispatcher: RequestDispatcher in dispatchers) {
                //å¦‚æœçº¿ç¨‹æ²¡æœ‰è¢«ä¸­æ–­ ä¸­æ–­çº¿ç¨‹
                if (!dispatcher.isInterrupted) {
                    dispatcher.interrupt()
                }
            }
            dispatchers.clear()
        }
    }

}
```

###### RequestDispatcher
åœ¨æ‰§è¡ŒåŠ è½½å›¾ç‰‡çš„æ—¶å€™æ˜¯éœ€è¦å¼€å¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç”±äºæ˜¯é˜»å¡å¼çš„æ‰€ä»¥ä¸ç³Šé€ æˆç•Œé¢çš„å¡é¡¿ï¼Œæ— æ³•ç†è§£çš„å¯ä»¥æƒ³æƒ³Handlerçš„æ­»å¾ªç¯è¯»å–messageï¼Œå¼‚æ›²åŒå·¥ã€‚
åœ¨è¿™é‡Œæˆ‘ä»¬è¿›è¡Œä¸€äº›å¯¹äºå›¾ç‰‡åŠ åŠ è½½ï¼Œä»å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œä¸­è¯»å–å›¾ç‰‡ï¼Œåˆ†åˆ«è¿›è¡Œä¸åŒçš„æ“ä½œæ¥å­˜æ”¾bitma
æˆ‘ä»¬åœ¨BitmapRequestä¸­ä¹Ÿæ”¾ç½®äº†ä¸€äº›å‚æ•°ï¼Œåœ¨è¿™é‡Œéƒ½å¯ä»¥ç”¨ä¸Š
ï¼ï¼ï¼è¿™é‡Œæ˜¯ç»§æ‰¿Threadçš„ï¼Œæ‰€ä»¥æ›´æ–°uiçš„æ“ä½œéƒ½éœ€è¦è½¬åˆ°ä¸»çº¿ç¨‹ä¸­ï¼Œè¿™é‡Œé‡‡ç”¨handleræ¥è¿›è¡Œçº¿ç¨‹è°ƒåº¦
```
class RequestDispatcher(requestQueue: BlockingQueue<BitmapRequest>) : Thread() {

    /*** Handler ç”¨æˆ·è·³è½¬åˆ°ä¸»çº¿ç¨‹è¿›è¡Œå±•ç¤ºå›¾ç‰‡ ***/
    private val handler by lazy { Handler(Looper.getMainLooper()) }

    /*** è¯·æ±‚é˜Ÿåˆ— ***/
    private val queue: BlockingQueue<BitmapRequest> = requestQueue

    /**
     * è¿è¡Œ
     */
    override fun run() {
        //æ­»å¾ªç¯ ç”±äºæ˜¯é˜»å¡å¼ åœ¨å­çº¿ç¨‹ä¸­ æ‰€ä»¥ä¸ä¼šå‘ç”Ÿç•Œé¢å¡é¡¿
        while (!isInterrupted) {
            //è·å–å½“å‰çš„ä»»åŠ¡
            try {
                val bitmapRequest: BitmapRequest = queue.take()
                //ç»™å›¾ç‰‡è®¾ç½®å ä½å›¾
                showPlaceHolder(bitmapRequest)
                //1ã€è·å–bitmap å…ˆä»ç¼“å­˜ä¸­è·å– æ²¡æœ‰å†ä»ç½‘ç»œè·å–
                val bitmap: Bitmap? = getBitmap(bitmapRequest)
                //2ã€é€šè¿‡Handleråˆ°uiçº¿ç¨‹å±•ç¤ºå›¾ç‰‡
                showImageInUiThread(bitmapRequest, bitmap)
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    /**
     * æ˜¾ç¤ºå ä½å›¾
     */
    private fun showPlaceHolder(request: BitmapRequest) {
        request.getPlaceHolder()?.let { placeHolder ->
            request.getImageView()?.let { imageView ->
                handler.post {
                    imageView.setImageResource(placeHolder)
                }
            }
        }
    }


    /**
     * ä»ç¼“å­˜ä¸­è·å–bitmap
     */
    private fun getBitmap(bitmapRequest: BitmapRequest): Bitmap? {
        //ä»ç¼“å­˜ä¸­è·å–bitmap å…ˆä»å†…å­˜ä¸­è·å– å†ä»ç£ç›˜ä¸­è·å–
        var bitmap: Bitmap? = DoubleCacheManager.get(bitmapRequest.getUriMd5())
        log("ç¼“å­˜è¯»å–æˆåŠŸï¼Ÿ ${bitmap != null} ")
        if (bitmap != null) {
            return bitmap
        } else {
            //ä»ç½‘ç»œä¸­è·å–
            bitmap = downloadImage(bitmapRequest.getImageUrl())
            return bitmap
        }
    }

    /**
     * ç½‘ç»œä¸‹è½½ç¼“å­˜
     */
    private fun downloadImage(uri: String?): Bitmap? {
        if (uri == null || uri.isEmpty()) {
            return null
        }
        var inputStream: InputStream? = null
        var bitmap: Bitmap? = null
        try {
            val url = URL(uri)
            val conn: URLConnection = url.openConnection()
            inputStream = conn.getInputStream()
            bitmap = BitmapFactory.decodeStream(inputStream)
            //ï¼ï¼ï¼å°†å›¾ç‰‡æ”¾å…¥ç¼“å­˜
            if (bitmap != null) {
                val key: String = MD5Utils.toMD5(uri)
                log("key = $key å­˜å…¥ç¼“å­˜")
                DoubleCacheManager.put(key, bitmap)
            }
        } catch (e: java.lang.Exception) {
            e.printStackTrace()
        } finally {
            try {
                inputStream?.close()
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
        return bitmap
    }

    /**
     * åœ¨uiçº¿ç¨‹ä¸­å±•ç¤ºå›¾ç‰‡
     */
    private fun showImageInUiThread(request: BitmapRequest, bitmap: Bitmap?) {
        //éœ€è¦åˆ¤æ–­å›¾ç‰‡æ˜¯å¦ä¸ºç©º å› ä¸ºæ˜¯è½¯åº”ç”¨
        //bitmapæ˜¯å¦ä¸ºç©º
        //tagæ˜¯å¦åŒ¹é…
        handler.post {
            val imageView: ImageView? = request.getImageView()
            val errorRes: Int? = request.getError()
            if (imageView != null && imageView.tag == request.getUriMd5()) {
                if (bitmap != null) {
                    imageView.setImageBitmap(bitmap)
                } else {
                    //bitmapä¸ºç©º è¯´æ˜åŠ è½½å¤±è´¥ æ˜¾ç¤ºé”™è¯¯å›¾ç‰‡
                    errorRes?.let {
                        imageView.setImageResource(it)
                    }
                }
            }
        }

        request.getRequestListener()?.let {
            if (bitmap != null) {
                handler.post {
                    it.onResourceReady(bitmap)
                }
            } else {
                handler.post {
                    it.onException()
                }
            }
        }
    }

}
```
#### ç”Ÿå‘½å‘¨æœŸ
é‚£ä¹ˆåˆ°è¿™é‡Œå›¾ç‰‡çš„åŠ è½½å’Œç¼“å­˜å°±å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯é‡ç‚¹çš„ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šï¼Œå…¶å®ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šå¾ˆç®€å•ï¼Œå°±å¾€ç®€å•äº†æƒ³ï¼Œä¸è¦å»æƒ³çš„å¤æ‚ï¼Œæ€è·¯ï¼š
1.é€šè¿‡ä¼ å…¥çš„ä¸Šä¸‹æ–‡åˆ›å»ºä¸€ä¸ªFragment
2.å…ˆè‡ªå®šä¹‰ä¸€ä¸ªHashMap<Int, ArrayList<String>>ï¼Œå†…éƒ¨å‚æ•°<Activityçš„HashCode,ArrayList<å†…å­˜ç¼“å­˜ä¸­bitmapçš„keyï¼Œå°±æ˜¯åœ°å€çš„MD5>>
è·å–åˆ°BitmapRequestçš„ä¸Šä¸‹æ–‡activityï¼Œè·å–activityçš„HashCode
è·å–é€šè¿‡åœ°å€å¾—åˆ°ä¸‰çº§ç¼“å­˜ä¸­æä¾›çš„bitmapä¹‹åï¼Œå°†keyï¼ˆBitmapRequestçš„uriMd5ï¼‰æ”¾å…¥ä¸Šæ–¹HashMapçš„HashCodeå¯¹åº”çš„åˆ—è¡¨ä¸­
3.åœ¨åˆ›å»ºçš„Fragmentè¢«é”€æ¯çš„æ—¶å€™ï¼Œç§»é™¤å†…å­˜ä¸­çš„bitmapå¹¶ä¸”å›æ”¶ï¼Œè°ƒç”¨gc

###### LifeCycleObservable
```
class LifeCycleObservable private constructor() {

    private val activityMap: HashMap<Int, ArrayList<String>> by lazy { hashMapOf<Int, ArrayList<String>>() }
    private val addCode: StringBuilder by lazy { StringBuilder() }
    private val removeCode: StringBuilder by lazy { StringBuilder() }

    companion object {
        val instance: LifeCycleObservable by lazy(mode = LazyThreadSafetyMode.SYNCHRONIZED) {
            LifeCycleObservable()
        }
    }

    /**
     * å°†ActivityCode å’Œ å¯¹åº”çš„bitmapçš„imageUrlMd5é›†åˆç›¸å¯¹åº”
     */
    fun add(activityCode: Int, imageUrlMd5: String) {
        addCode.append("activityCode = $activityCode  imageUrlMd5 = $imageUrlMd5 \n")
        var urlMd5List: ArrayList<String>? = activityMap[activityCode]
        if (urlMd5List == null) {
            urlMd5List = arrayListOf()
        }
        if (!urlMd5List.contains(imageUrlMd5)) {
            urlMd5List.add(imageUrlMd5)
        }
        activityMap[activityCode] = urlMd5List
        log("add  activityCode = $activityCode  imageUrlMd5 = $imageUrlMd5 urlMd5List = ${urlMd5List.size}")
    }


    fun remove(activityCode: Int) {
        val urlMd5List: ArrayList<String>? = activityMap[activityCode]
        urlMd5List?.let {
            for (imageUrlMd5 in it) {
                //åªæ˜¯ä»å†…å­˜ä¸­å°†æ‰€æœ‰çš„ç¼“å­˜è·å–
                val bitmap = DoubleCacheManager.get(imageUrlMd5, DoubleCacheManager.LRU)
                DoubleCacheManager.remove(imageUrlMd5, DoubleCacheManager.LRU)
                //å›æ”¶
                if (bitmap != null && !bitmap.isRecycled) {
                    bitmap.recycle()
                }
                removeCode.append("activityCode = $activityCode  imageUrlMd5 = $imageUrlMd5 \n")
            }
            //ç³»ç»Ÿå›æ”¶  æœ‰äº›æ‰‹æœºä¼šæ‰§è¡Œ æœ‰äº›æ‰‹æœºä¸ä¼šæ‰§è¡Œ å¯ä»¥è‡ªå·±æ‰‹åŠ¨GCæŸ¥çœ‹å†…å­˜
            System.gc()
            //ç›®å‰æ·»åŠ çš„å¿…åˆ é™¤çš„å¤š
            log("\nremoveCode \n$removeCode")
        }
        activityMap.clear()

    }

}
```


###### RequestDispatcherçš„run()ä¸­ï¼Œæ·»åŠ 
```
override fun run() {
        //æ­»å¾ªç¯ ç”±äºæ˜¯é˜»å¡å¼ åœ¨å­çº¿ç¨‹ä¸­ æ‰€ä»¥ä¸ä¼šå‘ç”Ÿç•Œé¢å¡é¡¿
        while (!isInterrupted) {
            //è·å–å½“å‰çš„ä»»åŠ¡
            try {
                val bitmapRequest: BitmapRequest = queue.take()
                showPlaceHolder(bitmapRequest)
                //1ã€è·å–bitmap å…ˆä»ç¼“å­˜ä¸­è·å– æ²¡æœ‰å†ä»ç½‘ç»œè·å–
                val bitmap: Bitmap? = getBitmap(bitmapRequest)
                //2ã€é€šè¿‡Handleråˆ°uiçº¿ç¨‹å±•ç¤ºå›¾ç‰‡
                showImageInUiThread(bitmapRequest, bitmap)
                //ç”Ÿå‘½å‘¨æœŸ
                //3ã€æ­¤æ—¶å·²ç»æŠŠç¼“å­˜æ”¾å…¥ é‚£ä¹ˆæŠŠç¼“å­˜çš„key uriMd5å’ŒActivityç»“åˆ
                val uriMd5 = bitmapRequest.getUriMd5()
                uriMd5?.let {
                    LifeCycleObservable.instance.add(bitmapRequest.getActivity().hashCode(), uriMd5)
                }
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }
```

###### RequestManagerFragment é”€æ¯

```

class RequestManagerFragment : Fragment() {

    private val activityCode: Int by lazy { activity!!.hashCode() }

    override fun onDetach() {
        super.onDetach()
        LifeCycleObservable.instance.remove(activityCode)
    }
}
```
#### ä¸‰ã€å†…å­˜å˜åŒ–æ•ˆæœå›¾
é¦–å…ˆæ˜¯è¿›å…¥é¦–é¡µï¼Œæ·»åŠ å­˜å‚¨æƒé™ï¼Œç‚¹å‡»è·³è½¬åˆ°å¦ä¸€ä¸ªç•Œé¢ï¼Œç‚¹å‡»åŠ è½½30å¤šå¼ å›¾ç‰‡ï¼Œä¸è¿›è¡Œå¤ç”¨ï¼Œå†…å­˜ä¼šæš´æ¶¨åˆ°300Mï¼Œç„¶åç‚¹å‡»é€€å‡ºï¼Œå°†å½“å‰ç•Œé¢ç»‘å®šçš„bitmapå…¨éƒ¨å›æ”¶ï¼Œå¹¶ä¸”è°ƒç”¨gcï¼Œå†…å­˜æ¢å¤åˆ°åˆå§‹çŠ¶æ€


![å†…å­˜å˜åŒ–.GIF](https://upload-images.jianshu.io/upload_images/4356451-0a14635b3677fc76.GIF?imageMogr2/auto-orient/strip)

#### å››ã€æºç åœ°å€
[ğŸ”¥ è‡ªå®šä¹‰Glideæ¥ç†è§£Glideè®¾è®¡æ¨¡å¼](https://github.com/zmemo/Glide)



